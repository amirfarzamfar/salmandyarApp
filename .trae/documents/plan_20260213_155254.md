# Medication Management System (MVP) Implementation Plan

This plan focuses on delivering the **MVP** features requested: Medication Kardex, Smart Scheduling, Administration Logging, and Audit Log, integrated into the existing Admin and Nurse portals.

## 1. Backend: Domain Layer Enhancements

**File:** `Salmandyar.Domain/Entities/Medications/PatientMedication.cs`

* Add `Form` (string), `Concentration` (string), `HighAlert` (bool).

* Add `Criticality` (Enum: Routine, Important, HighAlert, LifeSaving).

* Update `Frequency` handling to support flexible schedules.

**File:** `Salmandyar.Domain/Entities/Medications/MedicationDose.cs`

* Add `Status` (Enum: Scheduled, Due, Late, Taken, Missed, Cancelled).

* Add `SideEffectSeverity` (Enum) and `SideEffectDescription` (string).

* Add `MissedReason` (string).

**File:** `Salmandyar.Domain/Enums/MedicationEnums.cs` (New)

* Define `MedicationCriticality`, `DoseStatus`, `SideEffectSeverity`.

## 2. Backend: Application Layer & Business Logic

**File:** `Salmandyar.Application/Services/Medications/MedicationService.cs` (New)

* **`GetKardex(patientId)`**: Returns active medications.

* **`AddMedication(dto)`**: Creates a medication record and generates `MedicationDose` instances for the immediate future (e.g., next 7 days).

* **`GetDailySchedule(patientId, date)`**: Returns doses for a specific day.

* **`LogAdministration(doseId, status, details)`**:

  * Updates `MedicationDose` status.

  * Records `AuditLog` entry (Who, What, When).

  * Checks for simple alerts (e.g., Late dose).

**File:** `Salmandyar.Application/Services/Medications/Dtos/*.cs`

* Create DTOs for API communication (`MedicationDto`, `DoseLogDto`, etc.).

## 3. Backend: API Layer

**File:** `Salmandyar.API/Controllers/MedicationsController.cs` (New)

* `GET /api/patients/{id}/medications` (Kardex)

* `POST /api/patients/{id}/medications` (Add Med)

* `GET /api/patients/{id}/medications/schedule` (Daily View)

* `POST /api/medications/doses/{id}/log` (Action: Take/Skip/Late)

## 4. Frontend: Admin Panel Integration

**Location:** Patient Management -> Between Vital Signs and Services.
**File:** `frontend/src/app/dashboard/patients/[id]/page.tsx`

* Add a new tab `Medications` to the existing tab list.

* **Component:** `frontend/src/components/patients/tabs/MedicationTab.tsx` (New)

  * List current medications (Kardex View).

  * "Add Medication" button opening a modal form.

  * Form fields: Name, Dose, Route, Frequency, Start Date, Criticality, Instructions.

## 5. Frontend: Nurse Portal Integration

**Location:** `http://localhost:3000/nurse-portal/patient/[id]/`
**File:** `frontend/src/app/nurse-portal/patient/[id]/page.tsx`

* Add a generic "Medications" section or tab.

* **Component:** `frontend/src/components/nurse-portal/MedicationTracker.tsx` (New)

  * **Timeline View**: Display doses for "Today".

  * **Status Indicators**: Color-coded (Green=Taken, Red=Missed, Yellow=Due).

  * **Action**: "One-click Take" button.

  * **Exception Flow**: "Report Issue" button for Late/Missed/SideEffects.

## 6. Audit & Security

* Ensure `CurrentUserId` is captured for all actions.

* All `LogAdministration` calls will insert a record into `AuditLogs` table.

## 7. Verification

* **Test Scenario 1 (Admin)**: Add a new "Metformin" prescription (Twice daily).

* **Test Scenario 2 (Nurse)**: Verify 2 doses appear on the timeline.

* **Test Scenario 3 (Nurse)**: Mark morning dose as "Taken". Verify status update.

* **Test Scenario 4 (Nurse)**: Mark evening dose as "Missed" with reason. Verify log.

