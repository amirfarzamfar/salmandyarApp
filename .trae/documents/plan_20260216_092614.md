# Comprehensive Medication Management System Plan

## 1. Backend Implementation (Data & Logic)

### A. Entity Updates
We will extend the existing entities in `Salmandyar.Domain`:

1.  **`PatientMedication`**:
    *   Add `GracePeriodMinutes` (int, default 30).
    *   Add Notification flags: `NotifyPatient`, `NotifyNurse`, `NotifySupervisor`, `NotifyFamily`.
    *   Add `EscalationEnabled` (bool).

2.  **`MedicationDose`**:
    *   Add `AttachmentPath` (string, nullable) for photo evidence.
    *   Add `IsReminderSent` (bool).
    *   Add `EscalationLevel` (Enum: `None`, `NurseNotified`, `SupervisorNotified`, `FamilyNotified`).
    *   Add `LastEscalationTime` (DateTime, nullable).

### B. DTO Updates (`Salmandyar.Application`)
*   Update `CreateMedicationDto` to include the new fields (Grace Period, Notification flags).
*   Update `RecordDoseDto` to include `AttachmentPath` (handled as a file upload in controller, path string in DTO).

### C. Service Logic (`MedicationService`)
*   **Update `AddMedicationAsync`**: Save new configuration fields.
*   **Update `RecordDoseAsync`**: Handle attachment path saving and status updates.
*   **New Method `CheckMissedDosesAndEscalateAsync`**:
    *   Identify doses past grace period.
    *   Execute escalation logic (notify Nurse -> Supervisor -> Family).
    *   Log all actions to `AuditLogs`.

### D. Background Job (`MedicationBackgroundService`)
Create a new background service inheriting `BackgroundService` that runs every minute:
1.  **Reminders**: Find doses due in 15 mins (where `!IsReminderSent`). Send notifications.
2.  **Escalation**: Check for overdue doses and trigger `CheckMissedDosesAndEscalateAsync`.

---

## 2. Frontend Implementation (UI/UX)

### A. Medication Registration (Admin/Nurse Panel)
*   **Complex Scheduling UI**:
    *   Allow selecting "Frequency Type" (Daily, Interval).
    *   If "Daily", provide a multi-select time picker (e.g., "Add Time" button to list 08:00, 14:00, 20:00).
    *   Serialize these times into comma-separated string for `FrequencyDetail`.
*   **Settings**: Toggles for Reminders and Escalation preferences.

### B. Medication Dashboard (Nurse/Patient View)
*   **"Today's Meds" Widget**:
    *   Timeline view of doses for the current day.
    *   Color-coded status: Green (Taken), Yellow (Due Soon), Red (Overdue/Missed).
*   **Action Modal**:
    *   Opens when clicking a dose.
    *   Options: "Take Now" (Primary), "Report Issue/Missed".
    *   **Evidence**: File input for photo/scan (Camera access on mobile).
    *   **Details**: Notes input, Side effect selection.

### C. Notifications
*   Implement a `NotificationContext` or polling mechanism in Frontend to show real-time alerts (optional for this phase, but prepared for).

---

## 3. Execution Steps

1.  **Backend Models**: Update `PatientMedication` and `MedicationDose` entities.
2.  **Migrations**: Create and apply EF Core migration.
3.  **Backend Services**: Implement logic in `MedicationService` and create `MedicationBackgroundService`.
4.  **API**: Update `MedicationsController` to support file upload for evidence.
5.  **Frontend**: Build the UI components for registration and daily management.
