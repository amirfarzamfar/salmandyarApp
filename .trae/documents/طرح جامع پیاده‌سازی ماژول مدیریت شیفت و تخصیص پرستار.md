# طرح پیاده‌سازی ماژول مدیریت شیفت و تخصیص پرستار (Care Assignment Module)

این ماژول طبق اصول **Clean Architecture** و درخواست شما در دو بخش Backend و Frontend پیاده‌سازی خواهد شد.

---

## 1. Backend Implementation (.NET Core 8)

### **A. Domain Layer (`Salmandyar.Domain`)**
1.  **Enums**: ایجاد فایل‌های `AssignmentType.cs`, `ShiftSlot.cs`, `AssignmentStatus.cs`.
2.  **Entity**: ایجاد کلاس `CareAssignment.cs` با فیلدهای خواسته شده (ارتباط Many-to-Many با Payload) و فیلدهای Audit.

### **B. Infrastructure Layer (`Salmandyar.Infrastructure`)**
1.  **Configuration**: افزودن `DbSet<CareAssignment>` به `ApplicationDbContext`.
2.  **EF Configuration**: تنظیم روابط (Foreign Keys) و ایجاد **Index** روی `CaregiverId`, `PatientId`, `StartDate` برای افزایش پرفورمنس.
3.  **Migrations**: ایجاد مایگریشن جدید برای ساخت جدول.
4.  **Seed Data**: به‌روزرسانی `DbInitializer` برای افزودن داده‌های تست (۲ بیمار، ۳ پرستار و چند شیفت تداخلی).

### **C. Application Layer (`Salmandyar.Application`)**
1.  **DTOs**: ایجاد `CreateAssignmentDto`, `AssignmentDto`, `UpdateAssignmentStatusDto`.
2.  **Interface**: تعریف `ICareAssignmentService` برای جداسازی وابستگی‌ها.
3.  **Validation**: استفاده از **FluentValidation** برای اعتبارسنجی ورودی‌ها (تاریخ، نوع شیفت و...).

### **D. Service Implementation (Business Logic)**
1.  **Overlap Logic**: پیاده‌سازی منطق اصلی بررسی تداخل زمانی:
    *   `NewStart < ExistingEnd && ExistingStart < NewEnd`
    *   بررسی تداخل برای پرستار (یک پرستار نمی‌تواند همزمان دو جا باشد).
    *   بررسی تداخل برای بیمار (هشدار در صورت وجود پرستار اصلی فعال).

### **E. API Layer (`Salmandyar.API`)**
1.  **Controller**: ایجاد `CareAssignmentsController` با متدهای:
    *   `POST`: ایجاد تخصیص جدید.
    *   `PUT`: تغییر وضعیت (لغو/اتمام).
    *   `GET`: دریافت تقویم کاری (با فیلتر تاریخ و پرستار).

---

## 2. Frontend Implementation (Next.js & Tailwind)

### **A. API Service**
1.  ایجاد `src/services/assignment.service.ts` برای ارتباط با اندپوینت‌های جدید.

### **B. Admin Page (`/admin/shifts`)**
1.  **Layout**: ایجاد صفحه مدیریت شیفت در ستون سمت راست پنل ادمین.
2.  **State Management**: استفاده از `TanStack Query` (React Query) برای واکشی و کش کردن داده‌های تقویم.

### **C. Components**
1.  **`CaregiverSchedule` (Timeline View)**:
    *   نمایش گرافیکی شیفت‌ها به صورت بلوک‌های رنگی در طول هفته/ماه.
    *   قابلیت کلیک روی شیفت برای مشاهده جزئیات.
2.  **`AssignmentWizard` (Modal)**:
    *   فرم چند مرحله‌ای (Stepper) برای انتخاب بیمار، پرستار و زمان.
    *   نمایش خطاهای اعتبارسنجی (تداخل زمانی) که از Backend دریافت می‌شود.
    *   استفاده از `react-select` برای انتخاب‌های Async.

---

## 3. Execution Steps
1.  **Backend**: ساخت Entity و اعمال تغییرات دیتابیس.
2.  **Backend**: پیاده‌سازی سرویس و منطق تداخل.
3.  **Backend**: ایجاد کنترلر و تست با Swagger.
4.  **Frontend**: ساخت صفحه و اتصال به API.

این طرح تمامی نیازمندی‌های فنی و بیزنس لاجیک شما را پوشش می‌دهد. آیا مورد تایید است؟